<!DOCTYPE html>
<html>
<head><title>Practice</title>
<meta charset="utf-8">
<!-- <link rel="shortcut icon" type="image/png" href="pict/favicon.png"/> -->
<link rel="stylesheet" type="text/css" href="styles.css"/>
<link rel="stylesheet" type="text/css" href="layout.css"/>

</head>
<body>

<div class="header"><i>This is an automatically generated document.</i></div>
<div class="sidebar">
    <table class="sidebarAligner">
        <tr><td valign="top">
			<p><a href="about.html">About the course</a></p>
            <p><a href="index.html">Theory</a></p>
			<p><a href="installation.html">Minikube and kubectl installation</a></p>
			<p><a href="practice.html">Practice</a></p>
        </td></tr>
        <tr><td class="bottom" valign="bottom">
            <i>Generated by md2html_py 0.1.2
            <br />2021-07-04 23:30:26</i>
        </td></tr>
    </table>
</div>

<p>[<a href="installation.html">BACK</a>]</p>
<hr />
<div class="toc">
<ul>
<li><a href="#creating-minikube-cluster">Creating Minikube cluster</a></li>
<li><a href="#main-kubectl-commands">Main kubectl commands</a><ul>
<li><a href="#creating-a-deployment">Creating a Deployment</a></li>
<li><a href="#editing-deployments">Editing Deployments</a></li>
<li><a href="#debugging-pods">Debugging Pods</a></li>
<li><a href="#deleting-deployments">Deleting Deployments</a></li>
<li><a href="#applying-configuration-files">Applying configuration files</a></li>
<li><a href="#summarize-kubectl-commands">Summarize kubectl commands</a></li>
</ul>
</li>
<li><a href="#k8s-yaml-configuration-file">K8s YAML Configuration File</a><ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#three-parts-of-k8s-configuration-file">Three parts of K8s configuration file</a></li>
<li><a href="#format-of-configuration-file">Format of configuration file</a></li>
<li><a href="#blueprint-for-pods-template">Blueprint for Pods (template)</a></li>
<li><a href="#connecting-services-to-deployments-and-pods">Connecting Services to Deployments and Pods</a></li>
</ul>
</li>
<li><a href="#complete-demo-project">Complete demo project</a></li>
</ul>
</div>
<hr />
<p><em>Jul 3, 2021</em></p>
<h1 id="creating-minikube-cluster">Creating Minikube cluster</h1>
<p><a href="https://www.youtube.com/watch?v=X48VuDVv0do&amp;t=2489s">44:29</a></p>
<p>Starting minicube cluster.</p>
<blockquote>
<p>In non-Linux environment <code>--vm-driver</code> parameter must be used.</p>
</blockquote>
<pre class="highlight"><code class="language-shell">$ minikube start
.  .  .
* Done! kubectl is now configured to use "minikube" cluster and "default" namespace by default

$ minikube status
minikube
type: Control Plane
host: Running
kubelet: Running
apiserver: Running
kubeconfig: Configured

$ kubectl get nodes
NAME       STATUS   ROLES                  AGE   VERSION
minikube   Ready    control-plane,master   14h   v1.20.7</code></pre>

<p>There's the only Master Node so far.</p>
<hr />
<h1 id="main-kubectl-commands">Main <code>kubectl</code> commands</h1>
<p><a href="https://youtu.be/X48VuDVv0do?t=2692">44:52</a></p>
<h2 id="creating-a-deployment">Creating a Deployment</h2>
<pre class="highlight"><code class="language-shell">$ kubectl get pods
No resources found in default namespace.

$ kubectl get services
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   14h</code></pre>

<pre class="highlight"><code class="language-shell">$ kubectl create -h
Create a resource from a file or from stdin.

 JSON and YAML formats are accepted.
.  .  .
Available Commands:
.  .  .
  deployment          Create a deployment with the specified name.
  ingress             Create an ingress with the specified name.
  job                 Create a job with the specified name.
  secret              Create a secret using specified subcommand
  service             Create a service using specified subcommand.
.  .  .</code></pre>

<p>But there's no <code>pod</code> in the <code>Available Commands</code>. That's because we are not creating Pods
directly. We use Deployments (abstraction over Pods) instead.</p>
<pre class="highlight"><code class="language-shell">$ kubectl create deployment nginx-depl --image=nginx
deployment.apps/nginx-depl created</code></pre>

<p>This used the latest version of the image on the <a href="https://hub.docker.com/">Docker Hub</a>.</p>
<pre class="highlight"><code class="language-shell">$ kubectl get deployments
NAME         READY   UP-TO-DATE   AVAILABLE   AGE
nginx-depl   1/1     1            1           3m53s

$ kubectl get pods
NAME                          READY   STATUS    RESTARTS   AGE
nginx-depl-5c8bf76b5b-rmnmj   1/1     Running   0          5m2s

$ kubectl get replicasets
NAME                    DESIRED   CURRENT   READY   AGE
nginx-depl-5c8bf76b5b   1         1         1       6m59s</code></pre>

<h2 id="editing-deployments">Editing Deployments</h2>
<pre class="highlight"><code class="language-shell">$ kubectl edit deployment nginx-depl</code></pre>

<p>The auto-generated file of the Deployment will be opened in the text editor. Let's, for example,
replace <code>- image: nginx</code> by <code>- image: nginx:1.20</code> and save the configuration.</p>
<pre class="highlight"><code class="language-shell">deployment.apps/nginx-depl edited

greg@deimos:~$ kubectl get pods
NAME                          READY   STATUS    RESTARTS   AGE
nginx-depl-58f65d4b6f-hk44c   1/1     Running   0          30s

$ kubectl get replicasets
NAME                    DESIRED   CURRENT   READY   AGE
nginx-depl-58f65d4b6f   1         1         1       5m33s
nginx-depl-5c8bf76b5b   0         0         0       36m</code></pre>

<p>We see the new Deployment with the new ID and that the old deployment has no replicas in its
ReplicaSet.</p>
<h2 id="debugging-pods">Debugging Pods</h2>
<p><a href="https://youtu.be/X48VuDVv0do?t=3125">52:05</a></p>
<pre class="highlight"><code class="language-shell">$ kubectl logs nginx-depl-58f65d4b6f-hk44c
/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
/docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/
.  .  .
2021/07/03 10:06:05 [notice] 1#1: start worker process 35</code></pre>

<p>Let's create another deployment and look at its log:</p>
<pre class="highlight"><code class="language-shell">$ kubectl create deployment mongo-depl --image=mongo
deployment.apps/mongo-depl created

$ kubectl get pods
NAME                          READY   STATUS    RESTARTS   AGE
mongo-depl-5fd6b7d4b4-jj4b5   1/1     Running   0          47s
nginx-depl-58f65d4b6f-hk44c   1/1     Running   0          88m

$ kubectl logs mongo-depl-5fd6b7d4b4-jj4b5
{"t":{"$date":"2021-07-03T11:34:44.399+00:00"},"s":"I",  "c":"CONTROL",  "id":23285,   "ctx":"main",
"msg":"Automatically disabling TLS 1.0, to force-enable TLS 1.0 specify --sslDisabledProtocols 'none'"}
.  .  .
{"t":{"$date":"2021-07-03T11:34:45.075+00:00"},"s":"I",  "c":"NETWORK",  "id":23015,   
"ctx":"listener","msg":"Listening on","attr":{"address":"0.0.0.0"}}
{"t":{"$date":"2021-07-03T11:34:45.075+00:00"},"s":"I",  "c":"NETWORK",  "id":23016,   
"ctx":"listener","msg":"Waiting for connections","attr":{"port":27017,"ssl":"off"}}
.  .  .</code></pre>

<p>Getting Pod information:</p>
<pre class="highlight"><code class="language-shell">$ kubectl describe pod mongo-depl-5fd6b7d4b4-jj4b5
Name:         mongo-depl-5fd6b7d4b4-jj4b5
.  .  .
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  8m21s  default-scheduler  Successfully assigned default/mongo-depl-5fd6b7d4b4-jj4b5 to minikube
  Normal  Pulling    8m20s  kubelet            Pulling image "mongo"
  Normal  Pulled     7m38s  kubelet            Successfully pulled image "mongo" in 42.583008968s
  Normal  Created    7m37s  kubelet            Created container mongo
  Normal  Started    7m37s  kubelet            Started container mongo</code></pre>

<p>Another very useful command allows to enter a Pod as a <code>root</code> user:</p>
<pre class="highlight"><code class="language-shell">$ kubectl exec -it mongo-depl-5fd6b7d4b4-jj4b5 -- /bin/bash
root@mongo-depl-5fd6b7d4b4-jj4b5:/# whoami
root
root@mongo-depl-5fd6b7d4b4-jj4b5:/# exit
exit
$</code></pre>

<h2 id="deleting-deployments">Deleting Deployments</h2>
<p><a href="https://youtu.be/X48VuDVv0do?t=3311">55:11</a></p>
<pre class="highlight"><code class="language-shell">$ kubectl get deployments
NAME         READY   UP-TO-DATE   AVAILABLE   AGE
mongo-depl   1/1     1            1           22m
nginx-depl   1/1     1            1           141m

$ kubectl delete deployment mongo-depl
deployment.apps "mongo-depl" deleted

$ kubectl get pods
NAME                          READY   STATUS        RESTARTS   AGE
mongo-depl-5fd6b7d4b4-jj4b5   0/1     Terminating   0          22m
nginx-depl-58f65d4b6f-hk44c   1/1     Running       0          110m</code></pre>

<p>It needs some little time to complete the operation:</p>
<pre class="highlight"><code class="language-shell">$ kubectl get pods
NAME                          READY   STATUS    RESTARTS   AGE
nginx-depl-58f65d4b6f-hk44c   1/1     Running   0          110m

$ kubectl get replicasets
NAME                    DESIRED   CURRENT   READY   AGE
nginx-depl-58f65d4b6f   1         1         1       111m
nginx-depl-5c8bf76b5b   0         0         0       142m</code></pre>

<h2 id="applying-configuration-files">Applying configuration files</h2>
<p><a href="https://youtu.be/X48VuDVv0do?t=3378">56:18</a></p>
<p>We can do all the CRUD operation the similar way on the K8s components (like Deployments, Pods,
Services, etc.). We can specify all the parameters (like Deployment name, image name, etc.) in
the command line but that is impractical. That's why we would usually work with K8s
<strong>configuration files</strong>. </p>
<p>First create the configuration file:</p>
<pre class="highlight"><code class="language-shell">$ vi nginx-deployment.yaml</code></pre>

<p>Fill it with the content of the file
<a href="../fromAuthor/kubernetes-configuration-file-explained/nginx-deployment.yaml"><code>nginx-deployment.yaml</code></a>.</p>
<pre class="highlight"><code class="language-shell">$ kubectl apply -f nginx-deployment.yaml
deployment.apps/nginx-deployment created

$ kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
nginx-deployment-f4b7bbcbc-gpffv   1/1     Running   0          50s
nginx-deployment-f4b7bbcbc-w9tpc   1/1     Running   0          50s

$ kubectl get deployments
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   2/2     2            2           5m45s</code></pre>

<p>We see two Pods because we specified <code>replicas: 2</code> in the configuration file.</p>
<p>We can change the configuration file and apply it again. In this case K8s will update the
existing Deployment. For example, lets replace <code>replicas: 2</code> by <code>replicas: 1</code>:</p>
<pre class="highlight"><code class="language-shell">$ kubectl apply -f nginx-deployment.yaml
deployment.apps/nginx-deployment configured

$ kubectl get deployments
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   1/1     1            1           12m

$ kubectl get po
NAME                               READY   STATUS    RESTARTS   AGE
nginx-deployment-f4b7bbcbc-gpffv   1/1     Running   0          12m</code></pre>

<p>Here K8s decided itself which Pod to stop.</p>
<h2 id="summarize-kubectl-commands">Summarize <code>kubectl</code> commands</h2>
<p><a href="https://youtu.be/X48VuDVv0do?t=3674">1:01:14</a></p>
<p><strong>CRUD commands:</strong></p>
<ul>
<li>Create Deployment &mdash; <code>kubectl create deployment [name]</code></li>
<li>Edit Deployment &mdash; <code>kubectl edit deployment [name]</code></li>
<li>Delete Deployment &mdash; <code>kubectl delete deployment [name]</code></li>
</ul>
<p><strong>Status of K8s components:</strong> <code>kubectl get nodes | pods | services | replicasets | deployments</code></p>
<p><strong>Debugging Pods:</strong></p>
<ul>
<li>Log to console &mdash; <code>kubectl logs [pod name]</code></li>
<li>Get interactive terminal &mdash; <code>kubectl exec -it [pod name] -- /bin/bash</code></li>
<li>Get info about a Pod &mdash; <code>kubectl describe pod [pod name]</code></li>
</ul>
<p><strong>Use configuration file for CRUD:</strong></p>
<ul>
<li>Apply a configuration file &mdash; <code>kubectl apply -f [file name]</code></li>
<li>Delete with configuration file &mdash; <code>kubectl delete -f [file name]</code></li>
</ul>
<hr />
<h1 id="k8s-yaml-configuration-file">K8s YAML Configuration File</h1>
<p><a href="https://youtu.be/X48VuDVv0do?t=3723">1:02:03</a></p>
<h2 id="overview">Overview</h2>
<ul>
<li>The three parts of configuration file</li>
<li>Connecting Services to Deployments and Pods</li>
<li>Demo</li>
</ul>
<h2 id="three-parts-of-k8s-configuration-file">Three parts of K8s configuration file</h2>
<p>See <a href="../fromAuthor/kubernetes-configuration-file-explained/nginx-deployment.yaml">nginx-deployment.yaml</a>
and <a href="../fromAuthor/kubernetes-configuration-file-explained/nginx-service.yaml">nginx-service.yaml</a>.</p>
<p><code>kind: Deployment</code> and <code>kind: Service</code> show what we are going to create.</p>
<ul>
<li>First part is <code>matadata:</code></li>
<li>Second part is specification (<code>spec:</code>). It is specific to the kind of the component.</li>
<li>Third part is <code>status:</code> &mdash; automatically generated and added by K8s. This is how K8s
    <strong>continuously</strong> tracks the desired and the actual states and makes decides about the
    self-healing.</li>
</ul>
<p>The <code>status</code> information is held in the <a href="index.html#master_node_processes">etcd</a>.</p>
<p>If we specify and apply <code>spec/replicas: 2</code> but actual is:</p>
<pre class="highlight"><code class="language-shell">$ kubectl get deployment nginx-deployment -o yaml | less
.  .  .
apiVersion: apps/v1
kind: Deployment
metadata:
.  .  .
  name: nginx-deployment
.  .  .
status:
  availableReplicas: 1
.  .  .</code></pre>

<p>Then K8s will see the problem and will try to create a new replica ASAP.</p>
<h2 id="format-of-configuration-file">Format of configuration file</h2>
<p><a href="https://youtu.be/X48VuDVv0do?t=3938">1:05:38</a></p>
<p><strong>YAML</strong> (a recursive acronym for "<strong>YAML</strong> Ain't Markup Language"):
<a href="https://en.wikipedia.org/wiki/YAML">Wikipedia</a> |
<a href="https://yaml.org/">Official site</a>.</p>
<p>It's a good practice to store configuration files the code (see <a href="https://en.wikipedia.org/wiki/Infrastructure_as_code">IAAC, Infrastructure As Code,
concept</a>).</p>
<h2 id="blueprint-for-pods-template">Blueprint for Pods (<code>template</code>)</h2>
<p><a href="https://youtu.be/X48VuDVv0do?t=4009">1:06:49</a></p>
<p><img src="pict/deployment_abstraction_layers.png" style="float: left; margin: 0 25px 25px 0;" /></p>
<p>Whenever we want to create a Pod we create a Deployment and K8s takes care of the rest.</p>
<p>See <a href="../fromAuthor/kubernetes-configuration-file-explained/nginx-deployment.yaml">nginx-deployment.yaml</a>,
<code>spec/template:</code>. The template also has its metadata and specification. So it's a configuration file
inside a configuration file. The latter configuration applies to a Pod, so it is the <strong>blueprint</strong>
for a Pod.</p>
<p style="clear: both;"></p>

<h2 id="connecting-services-to-deployments-and-pods">Connecting Services to Deployments and Pods</h2>
<p><a href="https://youtu.be/X48VuDVv0do?t=4083">1:08:03</a></p>
<p>This is done using <strong>labels</strong> and <strong>selectors</strong>. Also see K8s documentation 
<a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/">Labels and Selectors</a>.</p>
<p><img alt="" src="pict/labels_and_selectors.png" /></p>
<p>See <a href="../fromAuthor/kubernetes-configuration-file-explained/nginx-deployment.yaml">nginx-deployment.yaml</a>
and <a href="../fromAuthor/kubernetes-configuration-file-explained/nginx-service.yaml">nginx-service.yaml</a>.</p>
<p><img src="pict/ports_01.png" style="float: left; margin: 0 25px 25px 0;" /></p>
<p><img alt="" src="pict/ports_02.png" /></p>
<p>So the Service will accept requests on the port <code>80</code> and forwards them the to port <code>8080</code> of the
Pod.</p>
<p style="clear: both;"></p>

<p>Placing the YAML files into the working accessible directory and applying them:</p>
<pre class="highlight"><code class="language-shell">$ kubectl apply -f nginx-deployment.yaml
deployment.apps/nginx-deployment unchanged

$ kubectl apply -f nginx-service.yaml
service/nginx-service created</code></pre>

<p>Now getting more detailed information about the Pods:</p>
<pre class="highlight"><code class="language-shell">$ kubectl get pods -o wide
NAME                               READY   STATUS    RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES
nginx-deployment-f4b7bbcbc-6kbgw   1/1     Running   0          30h   172.17.0.5   minikube   &lt;none&gt;           &lt;none&gt;
nginx-deployment-f4b7bbcbc-gpffv   1/1     Running   0          31h   172.17.0.6   minikube   &lt;none&gt;           &lt;none&gt;</code></pre>

<p>Two pods as we have <code>replicas: 2</code>. Looking at the service:</p>
<pre class="highlight"><code class="language-shell">$ kubectl get services
NAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
kubernetes      ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP   2d1h
nginx-service   ClusterIP   10.110.173.246   &lt;none&gt;        80/TCP    117s

$ kubectl describe service nginx-service
Name:              nginx-service
.  .  .
Selector:          app=nginx
.  .  .
TargetPort:        8080/TCP
Endpoints:         172.17.0.5:8080,172.17.0.6:8080
.  .  .</code></pre>

<p>Now let's look at the status (that is automatically generated):</p>
<pre class="highlight"><code class="language-shell">$ kubectl get deployment nginx-deployment -o yaml &gt; nginx-deployment-result.yaml

$ less nginx-deployment-result.yaml</code></pre>

<blockquote>
<p>This automatically generated configuration contains a lot of runtime data. So if we want to 
create a blueprint out of it then we need to clean it much.</p>
</blockquote>
<p>We can delete the components using configuration files:</p>
<pre class="highlight"><code class="language-shell">$ kubectl delete -f nginx-deployment.yaml
deployment.apps "nginx-deployment" deleted

$ kubectl delete -f nginx-service.yaml
service "nginx-service" deleted</code></pre>

<hr />
<h1 id="complete-demo-project">Complete demo project</h1>
<p><a href="https://youtu.be/X48VuDVv0do?t=4576">1:16:16</a></p>
<hr />
<hr />
<hr />
<hr />
<hr />
<p>[<a href="installation.html">BACK</a>]</p>
<hr />
<hr />
<hr />
<hr />
<hr />

</body>
</html>

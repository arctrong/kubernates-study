<!DOCTYPE html>
<html>
<head><title>Complete demo project</title>
<meta charset="utf-8">
<!-- <link rel="shortcut icon" type="image/png" href="pict/favicon.png"/> -->
<link rel="stylesheet" type="text/css" href="styles.css"/>
<link rel="stylesheet" type="text/css" href="layout.css"/>

</head>
<body>

<div class="header"><i>This is an automatically generated document.</i></div>
<div class="sidebar">
    <table class="sidebarAligner">
        <tr><td valign="top">
            
            <h3>Sections</h3>
            <p><a href="about.html">About the course</a></p>
            <p><a href="index.html">Theory</a></p>
            <p><a href="installation.html">Minikube and kubectl installation</a></p>
            <p><a href="kubectl_commands.html">Main kubectl commands</a></p>
            <p><a href="yaml_config_file.html">K8s YAML Configuration File</a></p>
            <p><a href="demo_project.html">Complete demo project</a></p>
            <p><a href="namespaces.html">K8s Namespaces</a></p>
            
            <h3>Side steps</h3>
            <p><a href="external_access.html">Access external Services from outside the minicube cluster</a></p>
            
        </td></tr>
        <tr><td class="bottom" valign="bottom">
            <i>Generated by md2html_py 0.1.2
            <br />2021-07-06 14:52:18</i>
        </td></tr>
    </table>
</div>

<p>[<a href="yaml_config_file.html">BACK</a>] | [<a href="namespaces.html">NEXT</a>]</p>
<hr />
<p><p style="font-size: 40px; font-weight: bold;">Complete demo project</p></p>
<div class="toc">
<ul>
<li><a href="#project-overview">Project overview</a></li>
<li><a href="#mongodb-deployment">MongoDB Deployment</a></li>
<li><a href="#mongodb-internal-service">MongoDB internal Service</a></li>
<li><a href="#mongo-express-deployment-and-configmap">Mongo Express Deployment and ConfigMap</a></li>
<li><a href="#mongo-express-external-service">Mongo Express external Service</a></li>
</ul>
</div>
<hr />
<h1 id="project-overview">Project overview</h1>
<p><a href="https://youtu.be/X48VuDVv0do?t=4576">1:16:16</a></p>
<p><img alt="" src="pict/project_overview.png" /></p>
<hr />
<h1 id="mongodb-deployment">MongoDB Deployment</h1>
<p><a href="https://youtu.be/X48VuDVv0do?t=4709">1:18:29</a></p>
<p>See <a href="../provided/demo-kubernetes-components/">provided/demo-kubernetes-components/</a>.</p>
<p>Minicube cluster must be running (if not start it with <code>minicube start</code>).</p>
<pre class="highlight"><code class="language-shell">$ kubectl get all
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   2d12h</code></pre>

<p>So the cluster is empty and we are starting from scratch.</p>
<p>We are going to create the file 
<a href="../provided/demo-kubernetes-components/mongo.yaml">provided/demo-kubernetes-components/mongo.yaml</a>.</p>
<pre class="highlight"><code class="language-shell">$ cd ~/Kubernates/mongo_demo

vi mongo.yaml</code></pre>

<p>Fill it with the initial configuration with lines <code>1..19</code>.</p>
<p>Then visiting <a href="https://hub.docker.com/_/mongo">MongoDB Docker Hub page</a> to find the image usage
details, particularly, that it listens on the port <code>27017</code> by default and uses environment
variables <code>MONGO_INITDB_ROOT_USERNAME</code> and <code>MONGO_INITDB_ROOT_PASSWORD</code>.</p>
<p>Adding this configuration but not specifying the exact secret values in the configuration file. 
Using Secret component instead. </p>
<p><img alt="" src="pict/secret_reference.png" /></p>
<p>Copying file
<a href="../provided/demo-kubernetes-components/mongo-secret.yaml">provided/demo-kubernetes-components/mongo-secret.yaml</a>
to our working directory. <code>type: Opaque</code> would be different if we used SSL/TLS. Here's the way
the base64-encoded strings were obtained.</p>
<pre class="highlight"><code class="language-shell">$ echo -n 'username' | base64
dXNlcm5hbWU=

$ echo -n 'password' | base64
cGFzc3dvcmQ=</code></pre>

<blockquote>
<p>This is not a secure way of keeping secret data. There are built-in encryption options that
are not enabled by default.</p>
</blockquote>
<p>Applying the Secret:</p>
<pre class="highlight"><code class="language-shell">$ kubectl apply -f mongo-secret.yaml
secret/mongodb-secret created

$ kubectl get secrets
NAME                  TYPE                                  DATA   AGE
default-token-fwttv   kubernetes.io/service-account-token   3      2d18h
mongodb-secret        Opaque                                2      56s</code></pre>

<p>Filling the <code>mongo.yaml</code> file. Instead of </p>
<pre class="highlight"><code class="language-code">        env:
        - name: MONGO_INITDB_ROOT_USERNAME
          value: username</code></pre>

<p>setting</p>
<pre class="highlight"><code class="language-code">        env:
        - name: MONGO_INITDB_ROOT_USERNAME
          valueFrom:
            secretKeyRef:
              name: mongodb-secret
              key: mongo-root-username</code></pre>

<p>Applying the Deployment:</p>
<pre class="highlight"><code class="language-shell">$ kubectl apply -f mongo.yaml
deployment.apps/mongodb-deployment created

$ kubectl get all
NAME                                      READY   STATUS    RESTARTS   AGE
pod/mongodb-deployment-796577dc64-l8sfd   1/1     Running   0          73s

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   2d18h

NAME                                 READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/mongodb-deployment   1/1     1            1           73s

NAME                                            DESIRED   CURRENT   READY   AGE
replicaset.apps/mongodb-deployment-796577dc64   1         1         1       73s</code></pre>

<p>So we see the running Pod, The Deployment and the ReplicaSet.</p>
<hr />
<h1 id="mongodb-internal-service">MongoDB internal Service</h1>
<p><a href="https://youtu.be/X48VuDVv0do?t=5327">1:28:48</a></p>
<p>We will define multiple documents in one YAML file (separated by <code>---</code>). Adding the lines starting
with <code>---</code> in file 
<a href="../provided/demo-kubernetes-components/mongo.yaml">provided/demo-kubernetes-components/mongo.yaml</a>
into the file with the same name in our working directory. This is reasonable since we cannot use
a DB server without a Service. In this part:</p>
<ul>
<li><code>kind: Secret</code> defines that a Service is configured;</li>
<li><code>selector/app: mongodb</code> links the Service with the Deployment;</li>
<li><code>port: 27017</code> &mdash; the port that's exposed outside;</li>
<li><code>targetPort: 27017</code> &mdash; the port in the target Pod where the requests will be forwarded.</li>
</ul>
<p>Now applying the same file:</p>
<pre class="highlight"><code class="language-shell">$ kubectl apply -f mongo.yaml
deployment.apps/mongodb-deployment unchanged
service/mongodb-service created

$ kubectl get services
NAME              TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)     AGE
kubernetes        ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP     2d19h
mongodb-service   ClusterIP   10.105.29.12   &lt;none&gt;        27017/TCP   78s

$ kubectl describe service mongodb-service
Name:              mongodb-service
.  .  .
Endpoints:         172.17.0.6:27017
.  .  .

$ kubectl get pods -o wide
NAME                                 READY   STATUS    RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES
mongodb-deployment-8f6675bc5-x2pzj   1/1     Running   0          15m   172.17.0.6   minikube   &lt;none&gt;           &lt;none&gt;</code></pre>

<hr />
<h1 id="mongo-express-deployment-and-configmap">Mongo Express Deployment and ConfigMap</h1>
<p><a href="https://youtu.be/X48VuDVv0do?t=5601">1:33:21</a></p>
<p>See <a href="../provided/demo-kubernetes-components/mongo-express.yaml">provided/demo-kubernetes-components/mongo-express.yaml</a>.
To create this file we visited the <a href="https://hub.docker.com/_/mongo-express">Mongo Express Docker Hub page</a>
found that Mongo Express server listens on the port <code>8081</code> by default and uses a lot of
environment variables from which we need:</p>
<ul>
<li><code>ME_CONFIG_MONGODB_PORT</code></li>
<li><code>ME_CONFIG_MONGODB_SERVER</code></li>
<li><code>ME_CONFIG_MONGODB_ADMINUSERNAME</code></li>
<li><code>ME_CONFIG_MONGODB_ADMINPASSWORD</code></li>
</ul>
<p>For the secret data we use the existing Secret component. For the other variables we are going to
create a ConfigMap component. Copying the file
<a href="../provided/demo-kubernetes-components/mongo-configmap.yaml">provided/demo-kubernetes-components/mongo-configmap.yaml</a>
to our working directory.</p>
<p>The references to the ConfigMap is done like this:</p>
<pre class="highlight"><code class="language-code">        - name: ME_CONFIG_MONGODB_SERVER
          valueFrom: 
            configMapKeyRef:
              name: mongodb-configmap
              key: database_url</code></pre>

<p>Applying first the ConfigMap, then the Deployment:</p>
<pre class="highlight"><code class="language-shell">$ kubectl apply -f mongo-configmap.yaml
configmap/mongodb-configmap created

$ kubectl apply -f mongo-express.yaml
deployment.apps/mongo-express created

$ kubectl get pods
NAME                                 READY   STATUS    RESTARTS   AGE
mongo-express-78fcf796b8-5t7jf       1/1     Running   0          92s
mongodb-deployment-8f6675bc5-x2pzj   1/1     Running   0          43m

$ kubectl logs mongo-express-78fcf796b8-5t7jf
.  .  .
Mongo Express server listening at http://0.0.0.0:8081
Server is open to allow connections from anyone (0.0.0.0)
.  .  .</code></pre>

<hr />
<h1 id="mongo-express-external-service">Mongo Express external Service</h1>
<p><a href="https://youtu.be/X48VuDVv0do?t=6014">1:40:14</a></p>
<p>Now we are going to expose the Mongo Express server for connection from browsers from the outside
the cluster. We are doing it the same way as in the file <code>mongo.yaml</code>, i.e. defining the Service
configuration in the same file <code>mongo-express.yaml</code>. What makes this Service <strong>external</strong>?</p>
<ul>
<li><code>spec/type: LoadBalancer</code>. Though it may be not a good name but in fact every external Service
    has a function of load balancing;</li>
<li><code>spec/ports/nodePort: 30000</code> &mdash; the port that will be visible from the outside. Must be
    between 30000 and 32767.</li>
</ul>
<p>Applying the created configuration file:</p>
<pre class="highlight"><code class="language-shell">$ kubectl apply -f mongo-express.yaml
deployment.apps/mongo-express unchanged
service/mongo-express-service created

$ kubectl get service
NAME                    TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
kubernetes              ClusterIP      10.96.0.1        &lt;none&gt;        443/TCP          2d20h
mongo-express-service   LoadBalancer   10.101.164.221   &lt;pending&gt;     8081:30000/TCP   67s
mongodb-service         ClusterIP      10.105.29.12     &lt;none&gt;        27017/TCP        55m</code></pre>

<blockquote>
<p><code>EXTERNAL-IP = &lt;pending&gt;</code> &mdash; this is because we run it in minikube, in a real K8s cluster we
will see a certain IP address.</p>
</blockquote>
<p>To open the Mongo Express web interface execute:</p>
<pre class="highlight"><code class="language-shell">$ minikube service mongo-express-service
|-----------|-----------------------|-------------|---------------------------|
| NAMESPACE |         NAME          | TARGET PORT |            URL            |
|-----------|-----------------------|-------------|---------------------------|
| default   | mongo-express-service |        8081 | http://192.168.49.2:30000 |
|-----------|-----------------------|-------------|---------------------------|
* Opening service default/mongo-express-service in default browser...
greg@deimos:~/Kubernates/mongo_demo$ MoTTY X11 proxy: Unsupported authorisation protocol
Unable to init server: Broadway display type not supported: localhost:10.0
Error: cannot open display: localhost:10.0</code></pre>

<p>This works when executing directly on the Ubuntu host. It opens the page in the default browser:</p>
<p><img alt="" src="pict/mongo-express-web.png" /></p>
<p>Use <a href="external_access.html#nginx_request_forwarding">these instructions</a> to adjust access from
outside the minicube cluster. The following URL must be used for forwarding:</p>
<pre class="highlight"><code class="language-shell">$ minikube service mongo-express-service --url=true
http://192.168.49.2:30000</code></pre>

<hr />
<p>[<a href="yaml_config_file.html">BACK</a>] | [<a href="namespaces.html">NEXT</a>]</p>
<hr />
<hr />
<hr />
<hr />
<hr />

</body>
</html>
